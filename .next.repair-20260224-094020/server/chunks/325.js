exports.id=325,exports.ids=[325],exports.modules={7634:(a,b,c)=>{"use strict";c.d(b,{BE:()=>h,Er:()=>g,Qq:()=>n,Rb:()=>m,hu:()=>k,zP:()=>l});var d=c(77598);let e=(0,c(57975).promisify)(d.scrypt),f="scrypt";async function g(a){let b=(0,d.randomBytes)(16).toString("hex"),c=await e(a,b,64);return`${f}$${b}$${c.toString("hex")}`}async function h(a,b){let[c,g,h]=b.split("$");if(c!==f||!g||!h)return!1;let i=await e(a,g,64),j=Buffer.from(h,"hex");return j.length===i.length&&(0,d.timingSafeEqual)(j,i)}function i(a){return Buffer.from(a).toString("base64").replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function j(){let a=process.env.AUTH_SECRET??process.env.JWT_SECRET;if(a)return a;throw Error("Missing AUTH_SECRET or JWT_SECRET")}function k(a){let b=Math.floor(Date.now()/1e3),c=Number.parseInt(process.env.AUTH_TOKEN_TTL_SECONDS??"604800",10),e={...a,iat:b,exp:b+c},f=i(JSON.stringify({alg:"HS256",typ:"JWT"})),g=i(JSON.stringify(e)),h=`${f}.${g}`,k=i((0,d.createHmac)("sha256",j()).update(h).digest());return`${h}.${k}`}function l(a){let[b,c,e]=a.split(".");if(!b||!c||!e)return null;let f=`${b}.${c}`,g=(0,d.createHmac)("sha256",j()).update(f).digest(),h=Buffer.from(e.replace(/-/g,"+").replace(/_/g,"/"),"base64");if(g.length!==h.length||!(0,d.timingSafeEqual)(g,h))return null;try{let a=JSON.parse(function(a){let b=a.replace(/-/g,"+").replace(/_/g,"/"),c=b+"=".repeat((4-b.length%4)%4);return Buffer.from(c,"base64").toString("utf-8")}(c));if(a.exp<=Math.floor(Date.now()/1e3))return null;return a}catch{return null}}function m(a){let b=a.headers.get("authorization");if(!b)return null;let[c,d]=b.split(" ");return c?.toLowerCase()==="bearer"&&d?d:null}function n(a,b){let c=a.headers.get("cookie");if(!c)return null;for(let a of c.split(";").map(a=>a.trim())){let[c,...d]=a.split("=");if(c===b)return decodeURIComponent(d.join("="))}return null}},8825:(a,b,c)=>{"use strict";c.d(b,{A:()=>g});var d=c(56037),e=c.n(d);let f=new d.Schema({book:{type:d.Schema.Types.ObjectId,ref:"Book",required:!0},user:{type:d.Schema.Types.ObjectId,ref:"User"},amount:{type:Number,required:!0,min:1},reward:{type:String},contributorName:{type:String},isPublic:{type:Boolean,default:!0},status:{type:String,enum:["pending","paid","refunded"],default:"pending"}},{timestamps:!0}),g=e().models.Contribution||e().model("Contribution",f)},11790:(a,b,c)=>{"use strict";c.d(b,{$:()=>i});var d=c(56037),e=c.n(d);let f=process.env.MONGODB_URI,g=global,h=g.mongoose??{conn:null,promise:null};async function i(){if(!f)throw Error("Missing MONGODB_URI in environment");return h.conn||(h.promise||(h.promise=e().connect(f,{bufferCommands:!1})),h.conn=await h.promise),h.conn}g.mongoose=h},12269:(a,b,c)=>{"use strict";c.d(b,{$U:()=>o,eB:()=>g,eg:()=>m,hz:()=>l,i:()=>k,oJ:()=>h,qM:()=>n,qy:()=>j,xH:()=>i});var d=c(56037),e=c.n(d),f=c(82468);function g(a){if(!a||"object"!=typeof a||Array.isArray(a))throw new f.hD("Body must be a JSON object",400);return a}function h(a,b,{min:c=1,max:d=5e3}={}){if("string"!=typeof a)throw new f.hD(`${b} must be a string`,400);let e=a.trim();if(e.length<c)throw new f.hD(`${b} is required`,400);if(e.length>d)throw new f.hD(`${b} is too long`,400);return e}function i(a,b="email"){let c=h(a,b,{min:3,max:320}).toLowerCase();if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(c))throw new f.hD("Invalid email format",400);return c}function j(a,b="password"){return h(a,b,{min:8,max:128})}function k(a,b,{min:c,max:d}={}){if("number"!=typeof a||Number.isNaN(a))throw new f.hD(`${b} must be a number`,400);if(void 0!==c&&a<c)throw new f.hD(`${b} must be >= ${c}`,400);if(void 0!==d&&a>d)throw new f.hD(`${b} must be <= ${d}`,400);return a}function l(a,b){let c=h(a,b,{min:1,max:64});if(!e().Types.ObjectId.isValid(c))throw new f.hD(`${b} must be a valid ObjectId`,400);return c}function m(a,b,c){if("string"!=typeof a||!c.includes(a))throw new f.hD(`${b} must be one of: ${c.join(", ")}`,400);return a}function n(a,b,c=5e3){if(null!=a)return h(a,b,{min:1,max:c})}function o(a,b="email"){if(null!=a)return i(a,b)}},32047:(a,b,c)=>{"use strict";c.d(b,{A:()=>h});var d=c(56037),e=c.n(d);let f=new d.Schema({book:{type:d.Schema.Types.ObjectId,ref:"Book",required:!0},quantity:{type:Number,required:!0,min:1},unitPrice:{type:Number,required:!0,min:0}},{_id:!1}),g=new d.Schema({user:{type:d.Schema.Types.ObjectId,ref:"User",required:!0},items:{type:[f],default:[]},total:{type:Number,required:!0,min:0},status:{type:String,enum:["pending","paid","cancelled","refunded"],default:"pending"},saleType:{type:String,enum:["direct","preorder"],required:!0},paymentMethod:{type:String,enum:["stripe","paypal","mobile_money"],required:!0},transactionId:{type:String},paymentReference:{type:String},promoCode:{type:String},invoiceNumber:{type:String,required:!0,unique:!0},invoicePdfBase64:{type:String},paidAt:{type:Date}},{timestamps:!0}),h=e().models.Order||e().model("Order",g)},38466:(a,b,c)=>{"use strict";c.d(b,{A:()=>f,o:()=>e});var d=c(12269);function e(a){let b=(0,d.eB)(a);return{email:(0,d.xH)(b.email)}}function f(a){let b=(0,d.eB)(a);return{token:(0,d.oJ)(b.token,"token",{min:20,max:300}),password:(0,d.qy)(b.password)}}},40934:(a,b,c)=>{"use strict";c.d(b,{mY:()=>r,Yt:()=>p,m_:()=>o,J1:()=>q,nR:()=>n});var d=c(11790),e=c(53386),f=c(8825),g=c(56037),h=c.n(g);let i=new g.Schema({to:{type:String,required:!0,lowercase:!0,trim:!0},subject:{type:String,required:!0},template:{type:String,required:!0},payload:{type:g.Schema.Types.Mixed},status:{type:String,enum:["queued","sent","failed"],default:"queued"},error:{type:String},sentAt:{type:Date}},{timestamps:!0}),j=h().models.EmailLog||h().model("EmailLog",i);var k=c(32047),l=c(77812);async function m(a){await (0,d.$)();let b=await j.create({to:a.to,subject:a.subject,template:a.template,payload:a.payload,status:"sent",sentAt:new Date});return console.log("[EMAIL]",{to:a.to,subject:a.subject,template:a.template}),b}async function n(a){return m({to:a.to,subject:"Bienvenue sur SENAME EDITION’S",template:"signup_welcome",payload:{name:a.name}})}async function o(a){return m({to:a.to,subject:"Confirmation de commande SENAME EDITION’S",template:"order_confirmation",payload:a})}async function p(a){return m({to:a.to,subject:"Confirmation de contribution SENAME EDITION’S",template:"contribution_confirmation",payload:a})}async function q(a){return m({to:a.to,subject:"R\xe9initialisation de mot de passe SENAME EDITION’S",template:"password_reset",payload:{token:a.token,expiresAt:a.expiresAt.toISOString()}})}async function r(){await (0,d.$)();let a=new Date,b=await e.A.find({saleType:"preorder",releaseDate:{$lte:a},preorderNotifiedAt:{$exists:!1}}).lean(),c=0;for(let d of b){for(let a of(await k.A.find({saleType:"preorder","items.book":d._id}).populate({path:"user",select:"email name"}).lean())){let b=a.user;b?.email&&(await m({to:b.email,subject:`Votre pr\xe9commande est disponible: ${d.title}`,template:"preorder_release",payload:{bookTitle:d.title,bookSlug:d.slug,name:b.name??"Lecteur"}}),c+=1)}await e.A.findByIdAndUpdate(d._id,{preorderNotifiedAt:a})}let g=await e.A.find({saleType:"crowdfunding",releaseDate:{$lte:a},campaignEndNotifiedAt:{$exists:!1}}).lean(),h=0;for(let b of g){let c=await f.A.find({book:b._id}).populate({path:"user",select:"email name"}).lean(),d=(b.fundingRaised??0)>=(b.fundingGoal??Number.MAX_SAFE_INTEGER);if(!d){let a=await f.A.find({book:b._id,status:"paid"},{user:1,amount:1}).lean();for(let c of(await f.A.updateMany({book:b._id,status:"paid"},{$set:{status:"refunded"}}),a))c.user&&await l.A.findByIdAndUpdate(c.user,{$inc:{rewardPoints:-Math.max(1,Math.floor(c.amount))}});await e.A.findByIdAndUpdate(b._id,{fundingRaised:0})}for(let a of c){let c=a.user;c?.email&&(await m({to:c.email,subject:`Fin de campagne: ${b.title}`,template:"campaign_end",payload:{bookTitle:b.title,bookSlug:b.slug,objectiveReached:d,raised:b.fundingRaised??0,goal:b.fundingGoal??0,name:c.name??"Lecteur"}}),h+=1)}await e.A.findByIdAndUpdate(b._id,{campaignEndNotifiedAt:a})}return{preorderEmailsSent:c,campaignEmailsSent:h}}},44244:(a,b,c)=>{"use strict";c.d(b,{w:()=>o,U:()=>p});var d=c(77598),e=c(82468),f=c(7634),g=c(11790),h=c(40934),i=c(56037),j=c.n(i);let k=new i.Schema({user:{type:i.Schema.Types.ObjectId,ref:"User",required:!0},tokenHash:{type:String,required:!0,index:!0},expiresAt:{type:Date,required:!0,index:!0},usedAt:{type:Date}},{timestamps:!0}),l=j().models.PasswordResetToken||j().model("PasswordResetToken",k);var m=c(77812);function n(a){return(0,d.createHash)("sha256").update(a).digest("hex")}async function o(a){await (0,g.$)();let b=await m.A.findOne({email:a.toLowerCase()}).lean();if(!b)return{success:!0};let c=(0,d.randomBytes)(32).toString("hex"),e=n(c),f=new Date(Date.now()+18e5);return await l.create({user:b._id,tokenHash:e,expiresAt:f}),await (0,h.J1)({to:b.email,token:c,expiresAt:f}),{success:!0,token:c,expiresAt:f}}async function p(a,b){await (0,g.$)();let c=n(a),d=await l.findOne({tokenHash:c,usedAt:{$exists:!1}});if(!d)throw new e.hD("Invalid reset token",400);if(d.expiresAt.getTime()<=Date.now())throw new e.hD("Reset token expired",400);let h=await (0,f.Er)(b);return await m.A.findByIdAndUpdate(d.user,{passwordHash:h}),d.usedAt=new Date,await d.save(),{success:!0}}},53386:(a,b,c)=>{"use strict";c.d(b,{A:()=>g});var d=c(56037),e=c.n(d);let f=new d.Schema({title:{type:String,required:!0,trim:!0},subtitle:{type:String,trim:!0},slug:{type:String,required:!0,unique:!0,lowercase:!0},description:{type:String,required:!0},price:{type:Number,required:!0,min:0},saleType:{type:String,enum:["direct","preorder","crowdfunding"],required:!0},releaseDate:{type:Date},coverImage:{type:String,required:!0},galleryImages:{type:[String],default:[]},isbn:{type:String},pages:{type:Number,min:1},stock:{type:Number,min:0},fundingGoal:{type:Number,min:0},fundingRaised:{type:Number,min:0,default:0},excerptUrl:{type:String},authorName:{type:String},tags:{type:[String],default:[]},preorderNotifiedAt:{type:Date},campaignEndNotifiedAt:{type:Date}},{timestamps:!0}),g=e().models.Book||e().model("Book",f)},77812:(a,b,c)=>{"use strict";c.d(b,{A:()=>g});var d=c(56037),e=c.n(d);let f=new d.Schema({name:{type:String,required:!0,trim:!0},email:{type:String,required:!0,unique:!0,lowercase:!0},passwordHash:{type:String,required:!0},role:{type:String,enum:["client","admin"],default:"client"},wishlist:[{type:d.Schema.Types.ObjectId,ref:"Book"}],rewardPoints:{type:Number,min:0,default:0},referredBy:{type:String,trim:!0}},{timestamps:!0}),g=e().models.User||e().model("User",f)},78335:()=>{},82468:(a,b,c)=>{"use strict";c.d(b,{Cv:()=>f,Vh:()=>h,hD:()=>e,hS:()=>i});var d=c(10641);class e extends Error{constructor(a,b=400){super(a),this.status=b}}function f(a,b=200){return d.NextResponse.json({data:a},{status:b})}function g(a,b=400){return d.NextResponse.json({error:a},{status:b})}async function h(a){try{return await a.json()}catch{throw new e("Invalid JSON body",400)}}function i(a){return a instanceof e?g(a.message,a.status):(a instanceof Error&&console.error("[API_ERROR]",a),g("Internal server error",500))}},96487:()=>{}};