"use strict";exports.id=7611,exports.ids=[7611],exports.modules={5410:(a,b,c)=>{c.d(b,{A:()=>g});var d=c(56037),e=c.n(d);let f=new d.Schema({book:{type:d.Schema.Types.ObjectId,ref:"Book",required:!0},user:{type:d.Schema.Types.ObjectId,ref:"User",required:!0},rating:{type:Number,required:!0,min:1,max:5},content:{type:String,required:!0},reviewerName:{type:String,trim:!0},reviewerEmail:{type:String,lowercase:!0,trim:!0},status:{type:String,enum:["pending","approved","rejected"],default:"pending"},authorReply:{type:String},reportCount:{type:Number,default:0,min:0},reportedBy:[{type:d.Schema.Types.ObjectId,ref:"User"}]},{timestamps:!0}),g=e().models.Comment||e().model("Comment",f)},27611:(a,b,c)=>{c.d(b,{BV:()=>z,Ej:()=>D,FZ:()=>F,KU:()=>E,Kl:()=>u,Kv:()=>t,Mp:()=>x,Tk:()=>v,Z7:()=>C,dE:()=>B,eB:()=>y,lm:()=>s,ph:()=>w,pi:()=>A,tf:()=>q,us:()=>p,v_:()=>r});var d=c(82468),e=c(11790),f=c(53386),g=c(5410),h=c(8825),i=c(32047),j=c(72969),k=c(35385),l=c(77812),m=c(7026),n=c(57285),o=c(91352);async function p(){return await (0,e.$)(),(await l.A.find({},{name:1,email:1,role:1}).sort({_id:-1}).lean()).map(a=>({id:a._id.toString(),name:a.name,email:a.email,role:a.role}))}async function q(){return await (0,e.$)(),(await j.A.find({},{orderId:1,userId:1,provider:1,kind:1,providerEventId:1,providerReference:1,status:1,amount:1,currency:1,createdAt:1}).sort({_id:-1}).limit(500).lean()).map(a=>({id:a._id.toString(),orderId:a.orderId?a.orderId.toString():null,userId:a.userId?a.userId.toString():null,provider:a.provider,kind:a.kind,providerEventId:a.providerEventId??null,providerReference:a.providerReference??null,status:a.status,amount:a.amount??null,currency:a.currency??null,createdAt:a.createdAt??null}))}async function r(a){await (0,e.$)();let b=await l.A.findByIdAndUpdate(a.userId,{role:a.role},{new:!0,projection:{name:1,email:1,role:1}}).lean();if(!b)throw new d.hD("User not found",404);return{id:b._id.toString(),name:b.name,email:b.email,role:b.role}}async function s(){return await (0,e.$)(),(await i.A.find({},{user:1,total:1,status:1,saleType:1,paymentMethod:1,invoiceNumber:1}).sort({_id:-1}).limit(200).lean()).map(a=>({id:a._id.toString(),userId:a.user.toString(),total:a.total,status:a.status,saleType:a.saleType,paymentMethod:a.paymentMethod,invoiceNumber:a.invoiceNumber}))}async function t(a){if(await (0,e.$)(),"paid"===a.status){let b=await (0,m.wA)({orderId:a.orderId,paymentMethod:"mobile_money",transactionId:`admin_${Date.now()}`});return{id:b._id.toString(),userId:b.user.toString(),total:b.total,status:b.status,saleType:b.saleType,paymentMethod:b.paymentMethod,invoiceNumber:b.invoiceNumber}}if("refunded"===a.status){let b=await i.A.findById(a.orderId,{user:1,total:1,status:1,saleType:1,paymentMethod:1,invoiceNumber:1,transactionId:1,paymentReference:1});if(!b)throw new d.hD("Order not found",404);if("refunded"===b.status)return{id:b._id.toString(),userId:b.user.toString(),total:b.total,status:b.status,saleType:b.saleType,paymentMethod:b.paymentMethod,invoiceNumber:b.invoiceNumber};if("paid"!==b.status)throw new d.hD("Only paid orders can be refunded",409);if("stripe"===b.paymentMethod){if(!b.transactionId)throw new d.hD("Missing Stripe payment intent",409);let a=await (0,o.aA)({paymentIntentId:b.transactionId}),c="string"==typeof a.id?a.id:void 0;await (0,m.HW)({orderId:b._id.toString(),paymentReference:c}),await (0,n.g)({orderId:b._id.toString(),userId:b.user.toString(),provider:"stripe",kind:"refund",providerReference:c??b.transactionId,status:"succeeded",amount:b.total,currency:"EUR"})}else if("paypal"===b.paymentMethod){if(!b.transactionId)throw new d.hD("Missing PayPal capture ID",409);let a=await (0,o.ud)({captureId:b.transactionId}),c="string"==typeof a.id?a.id:void 0;await (0,m.HW)({orderId:b._id.toString(),paymentReference:c}),await (0,n.g)({orderId:b._id.toString(),userId:b.user.toString(),provider:"paypal",kind:"refund",providerReference:c??b.transactionId,status:"succeeded",amount:b.total,currency:"EUR"})}else throw new d.hD("Refund is not supported for this payment method",409);let c=await i.A.findById(a.orderId,{user:1,total:1,status:1,saleType:1,paymentMethod:1,invoiceNumber:1});if(!c)throw new d.hD("Order not found",404);return{id:c._id.toString(),userId:c.user.toString(),total:c.total,status:c.status,saleType:c.saleType,paymentMethod:c.paymentMethod,invoiceNumber:c.invoiceNumber}}let b=await i.A.findById(a.orderId,{user:1,total:1,status:1,saleType:1,paymentMethod:1,invoiceNumber:1});if(!b)throw new d.hD("Order not found",404);if(b.status!==a.status){let a=Math.max(1,Math.floor(b.total));"paid"===b.status&&await l.A.findByIdAndUpdate(b.user,{$inc:{rewardPoints:-a}})}b.status=a.status,await b.save();let c=b.toObject();return{id:c._id.toString(),userId:c.user.toString(),total:c.total,status:c.status,saleType:c.saleType,paymentMethod:c.paymentMethod,invoiceNumber:c.invoiceNumber}}async function u(){return await (0,e.$)(),(await g.A.find({},{user:1,book:1,rating:1,content:1,status:1,authorReply:1,reportCount:1,reviewerName:1,reviewerEmail:1}).sort({_id:-1}).limit(200).populate({path:"user",select:"name email"}).populate({path:"book",select:"title slug"}).lean()).map(a=>({userRef:a.user,bookRef:a.book,id:a._id.toString(),userId:"function"==typeof a.user?._id?.toString?a.user._id.toString():"",userName:a.user?.name??"Lecteur",userEmail:a.user?.email??"",bookId:"function"==typeof a.book?._id?.toString?a.book._id.toString():"",bookTitle:a.book?.title??"Ouvrage",bookSlug:a.book?.slug??"",reviewerName:a.reviewerName,reviewerEmail:a.reviewerEmail,rating:a.rating,content:a.content,status:a.status,authorReply:a.authorReply,reportCount:a.reportCount??0})).map(({userRef:a,bookRef:b,...c})=>c)}async function v(a){await (0,e.$)();let b=await g.A.findByIdAndUpdate(a.commentId,{status:a.status},{new:!0,projection:{user:1,book:1,rating:1,content:1,status:1,authorReply:1,reportCount:1,reviewerName:1,reviewerEmail:1}}).populate({path:"user",select:"name email"}).populate({path:"book",select:"title slug"}).lean();if(!b)throw new d.hD("Comment not found",404);return{id:b._id.toString(),userId:"function"==typeof b.user?._id?.toString?b.user._id.toString():"",userName:b.user?.name??"Lecteur",userEmail:b.user?.email??"",bookId:"function"==typeof b.book?._id?.toString?b.book._id.toString():"",bookTitle:b.book?.title??"Ouvrage",bookSlug:b.book?.slug??"",reviewerName:b.reviewerName,reviewerEmail:b.reviewerEmail,rating:b.rating,content:b.content,status:b.status,authorReply:b.authorReply,reportCount:b.reportCount??0}}async function w(){return await (0,e.$)(),(await h.A.find({},{user:1,book:1,amount:1,reward:1,contributorName:1,isPublic:1,status:1}).sort({_id:-1}).limit(200).lean()).map(a=>({id:a._id.toString(),userId:a.user?a.user.toString():null,bookId:a.book.toString(),amount:a.amount,reward:a.reward,contributorName:a.contributorName,isPublic:a.isPublic,status:a.status}))}async function x(a){await (0,e.$)();let b=await h.A.findById(a.contributionId,{user:1,book:1,amount:1,reward:1,contributorName:1,isPublic:1,status:1});if(!b)throw new d.hD("Contribution not found",404);return b.status!==a.status&&("paid"!==b.status&&"paid"===a.status&&(await f.A.findByIdAndUpdate(b.book,{$inc:{fundingRaised:b.amount}}),b.user&&await l.A.findByIdAndUpdate(b.user,{$inc:{rewardPoints:Math.max(1,Math.floor(b.amount))}})),"paid"===b.status&&"paid"!==a.status&&(await f.A.findByIdAndUpdate(b.book,{$inc:{fundingRaised:-b.amount}}),b.user&&await l.A.findByIdAndUpdate(b.user,{$inc:{rewardPoints:-Math.max(1,Math.floor(b.amount))}}))),b.status=a.status,await b.save(),{id:b._id.toString(),userId:b.user?b.user.toString():null,bookId:b.book.toString(),amount:b.amount,reward:b.reward,contributorName:b.contributorName,isPublic:b.isPublic,status:b.status}}async function y(){return await (0,e.$)(),(await f.A.find({},{title:1,slug:1,subtitle:1,description:1,price:1,saleType:1,stock:1,fundingGoal:1,fundingRaised:1,coverImage:1,releaseDate:1,excerptUrl:1}).sort({_id:-1}).lean()).map(a=>({id:a._id.toString(),title:a.title,slug:a.slug,subtitle:a.subtitle,description:a.description,price:a.price,saleType:a.saleType,stock:a.stock,fundingGoal:a.fundingGoal,fundingRaised:a.fundingRaised,coverImage:a.coverImage,releaseDate:a.releaseDate,excerptUrl:a.excerptUrl}))}async function z(a){await (0,e.$)();let b=await f.A.findByIdAndDelete(a).lean();if(!b)throw new d.hD("Book not found",404);return{id:b._id.toString()}}async function A(a){await (0,e.$)();let b=await f.A.findById(a.bookId,{saleType:1,stock:1,fundingGoal:1}).lean();if(!b)throw new d.hD("Book not found",404);let c=a.saleType??b.saleType,g=a.stock??b.stock,h=a.fundingGoal??b.fundingGoal;if(("direct"===c||"preorder"===c)&&null==g)throw new d.hD("stock is required for direct/preorder books",400);if("crowdfunding"===c&&null==h)throw new d.hD("fundingGoal is required for crowdfunding books",400);let i={};void 0!==a.title&&(i.title=a.title),void 0!==a.slug&&(i.slug=a.slug.toLowerCase()),void 0!==a.subtitle&&(i.subtitle=a.subtitle),void 0!==a.description&&(i.description=a.description),void 0!==a.coverImage&&(i.coverImage=a.coverImage),void 0!==a.saleType&&(i.saleType=a.saleType),void 0!==a.releaseDate&&(i.releaseDate=a.releaseDate?new Date(a.releaseDate):null),void 0!==a.excerptUrl&&(i.excerptUrl=a.excerptUrl),void 0!==a.price&&(i.price=a.price),void 0!==a.stock&&(i.stock=a.stock),void 0!==a.fundingGoal&&(i.fundingGoal=a.fundingGoal),void 0!==a.fundingRaised&&(i.fundingRaised=a.fundingRaised);let j=await f.A.findByIdAndUpdate(a.bookId,i,{new:!0,projection:{title:1,slug:1,subtitle:1,description:1,price:1,saleType:1,stock:1,fundingGoal:1,fundingRaised:1,coverImage:1,releaseDate:1,excerptUrl:1}}).lean();if(!j)throw new d.hD("Book not found",404);return{id:j._id.toString(),title:j.title,slug:j.slug,subtitle:j.subtitle,description:j.description,price:j.price,saleType:j.saleType,stock:j.stock,fundingGoal:j.fundingGoal,fundingRaised:j.fundingRaised,coverImage:j.coverImage,releaseDate:j.releaseDate,excerptUrl:j.excerptUrl}}async function B(){await (0,e.$)();let[a,b,c,d,j,k,m,n,o,p]=await Promise.all([l.A.countDocuments({}),f.A.countDocuments({}),i.A.countDocuments({}),h.A.countDocuments({}),g.A.countDocuments({status:"pending"}),i.A.aggregate([{$match:{status:"paid"}},{$group:{_id:null,total:{$sum:"$total"}}}]),h.A.aggregate([{$match:{status:"paid"}},{$group:{_id:null,total:{$sum:"$amount"}}}]),i.A.aggregate([{$match:{status:"paid"}},{$group:{_id:"$saleType",count:{$sum:1},total:{$sum:"$total"}}}]),i.A.aggregate([{$match:{status:"paid"}},{$unwind:"$items"},{$group:{_id:"$items.book",quantitySold:{$sum:"$items.quantity"},revenue:{$sum:{$multiply:["$items.quantity","$items.unitPrice"]}}}},{$sort:{quantitySold:-1}},{$limit:5},{$lookup:{from:"books",localField:"_id",foreignField:"_id",as:"book"}},{$project:{_id:0,bookId:{$toString:"$_id"},title:{$ifNull:[{$arrayElemAt:["$book.title",0]},"Ouvrage supprim\xe9"]},quantitySold:1,revenue:1}}]),h.A.aggregate([{$match:{status:{$in:["pending","paid"]}}},{$group:{_id:"$book",collected:{$sum:"$amount"}}},{$sort:{collected:-1}},{$limit:8},{$lookup:{from:"books",localField:"_id",foreignField:"_id",as:"book"}},{$project:{_id:0,bookId:{$toString:"$_id"},title:{$ifNull:[{$arrayElemAt:["$book.title",0]},"Campagne supprim\xe9e"]},collected:1,goal:{$ifNull:[{$arrayElemAt:["$book.fundingGoal",0]},0]}}}])]),q=["direct","preorder","crowdfunding"].map(a=>{let b=n.find(b=>b._id===a);return{type:a,count:b?.count??0,total:b?.total??0}});return{usersCount:a,booksCount:b,ordersCount:c,contributionsCount:d,pendingCommentsCount:j,paidRevenue:k[0]?.total??0,paidContributions:m[0]?.total??0,salesByType:q,topBooks:o,campaignFunding:p}}async function C(a){let b=process.env.ADMIN_BOOTSTRAP_SECRET;if(!b)throw new d.hD("ADMIN_BOOTSTRAP_SECRET is not configured",500);if(a.secret!==b)throw new d.hD("Invalid bootstrap secret",401);await (0,e.$)();let c=await l.A.findOneAndUpdate({email:a.email.toLowerCase()},{role:"admin"},{new:!0,projection:{name:1,email:1,role:1}}).lean();if(!c)throw new d.hD("User not found",404);return{id:c._id.toString(),name:c.name,email:c.email,role:c.role}}async function D(){return await (0,e.$)(),(await k.A.find({}).sort({_id:-1}).limit(300).lean()).map(a=>({id:a._id.toString(),code:a.code,type:a.type,value:a.value,minSubtotal:a.minSubtotal??0,maxDiscount:a.maxDiscount,usageLimit:a.usageLimit,usedCount:a.usedCount??0,active:a.active,expiresAt:a.expiresAt}))}async function E(a){await (0,e.$)();let b=await k.A.create({code:a.code.toUpperCase(),type:a.type,value:a.value,minSubtotal:a.minSubtotal,maxDiscount:a.maxDiscount,usageLimit:a.usageLimit,expiresAt:a.expiresAt?new Date(a.expiresAt):void 0});return{id:b._id.toString(),code:b.code,type:b.type,value:b.value,minSubtotal:b.minSubtotal??0,maxDiscount:b.maxDiscount,usageLimit:b.usageLimit,usedCount:b.usedCount??0,active:b.active,expiresAt:b.expiresAt}}async function F(a){await (0,e.$)();let b={};void 0!==a.active&&(b.active=a.active);let c=await k.A.findByIdAndUpdate(a.promoId,b,{new:!0}).lean();if(!c)throw new d.hD("Promo not found",404);return{id:c._id.toString(),code:c.code,type:c.type,value:c.value,minSubtotal:c.minSubtotal??0,maxDiscount:c.maxDiscount,usageLimit:c.usageLimit,usedCount:c.usedCount??0,active:c.active,expiresAt:c.expiresAt}}}};