exports.id=3541,exports.ids=[3541],exports.modules={7634:(a,b,c)=>{"use strict";c.d(b,{BE:()=>h,Er:()=>g,Qq:()=>n,Rb:()=>m,hu:()=>k,zP:()=>l});var d=c(77598);let e=(0,c(57975).promisify)(d.scrypt),f="scrypt";async function g(a){let b=(0,d.randomBytes)(16).toString("hex"),c=await e(a,b,64);return`${f}$${b}$${c.toString("hex")}`}async function h(a,b){let[c,g,h]=b.split("$");if(c!==f||!g||!h)return!1;let i=await e(a,g,64),j=Buffer.from(h,"hex");return j.length===i.length&&(0,d.timingSafeEqual)(j,i)}function i(a){return Buffer.from(a).toString("base64").replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function j(){let a=process.env.AUTH_SECRET??process.env.JWT_SECRET;if(a)return a;throw Error("Missing AUTH_SECRET or JWT_SECRET")}function k(a){let b=Math.floor(Date.now()/1e3),c=Number.parseInt(process.env.AUTH_TOKEN_TTL_SECONDS??"604800",10),e={...a,iat:b,exp:b+c},f=i(JSON.stringify({alg:"HS256",typ:"JWT"})),g=i(JSON.stringify(e)),h=`${f}.${g}`,k=i((0,d.createHmac)("sha256",j()).update(h).digest());return`${h}.${k}`}function l(a){let[b,c,e]=a.split(".");if(!b||!c||!e)return null;let f=`${b}.${c}`,g=(0,d.createHmac)("sha256",j()).update(f).digest(),h=Buffer.from(e.replace(/-/g,"+").replace(/_/g,"/"),"base64");if(g.length!==h.length||!(0,d.timingSafeEqual)(g,h))return null;try{let a=JSON.parse(function(a){let b=a.replace(/-/g,"+").replace(/_/g,"/"),c=b+"=".repeat((4-b.length%4)%4);return Buffer.from(c,"base64").toString("utf-8")}(c));if(a.exp<=Math.floor(Date.now()/1e3))return null;return a}catch{return null}}function m(a){let b=a.headers.get("authorization");if(!b)return null;let[c,d]=b.split(" ");return c?.toLowerCase()==="bearer"&&d?d:null}function n(a,b){let c=a.headers.get("cookie");if(!c)return null;for(let a of c.split(";").map(a=>a.trim())){let[c,...d]=a.split("=");if(c===b)return decodeURIComponent(d.join("="))}return null}},8825:(a,b,c)=>{"use strict";c.d(b,{A:()=>g});var d=c(56037),e=c.n(d);let f=new d.Schema({book:{type:d.Schema.Types.ObjectId,ref:"Book",required:!0},user:{type:d.Schema.Types.ObjectId,ref:"User"},amount:{type:Number,required:!0,min:1},reward:{type:String},contributorName:{type:String},isPublic:{type:Boolean,default:!0},status:{type:String,enum:["pending","paid","refunded"],default:"pending"}},{timestamps:!0}),g=e().models.Contribution||e().model("Contribution",f)},11790:(a,b,c)=>{"use strict";c.d(b,{$:()=>i});var d=c(56037),e=c.n(d);let f=process.env.MONGODB_URI,g=global,h=g.mongoose??{conn:null,promise:null};async function i(){if(!f)throw Error("Missing MONGODB_URI in environment");return h.conn||(h.promise||(h.promise=e().connect(f,{bufferCommands:!1})),h.conn=await h.promise),h.conn}g.mongoose=h},32047:(a,b,c)=>{"use strict";c.d(b,{A:()=>h});var d=c(56037),e=c.n(d);let f=new d.Schema({book:{type:d.Schema.Types.ObjectId,ref:"Book",required:!0},quantity:{type:Number,required:!0,min:1},unitPrice:{type:Number,required:!0,min:0}},{_id:!1}),g=new d.Schema({user:{type:d.Schema.Types.ObjectId,ref:"User",required:!0},items:{type:[f],default:[]},total:{type:Number,required:!0,min:0},status:{type:String,enum:["pending","paid","cancelled","refunded"],default:"pending"},saleType:{type:String,enum:["direct","preorder"],required:!0},paymentMethod:{type:String,enum:["stripe","paypal","mobile_money"],required:!0},transactionId:{type:String},paymentReference:{type:String},promoCode:{type:String},invoiceNumber:{type:String,required:!0,unique:!0},invoicePdfBase64:{type:String},paidAt:{type:Date}},{timestamps:!0}),h=e().models.Order||e().model("Order",g)},35576:(a,b,c)=>{"use strict";c.d(b,{Cz:()=>n,E$:()=>j,g2:()=>l,iI:()=>o,lC:()=>p,r7:()=>k,wu:()=>m});var d=c(82468),e=c(11790),f=c(53386),g=c(8825),h=c(32047),i=c(77812);async function j(a){await (0,e.$)();let b=await i.A.findById(a,{name:1,email:1,role:1,rewardPoints:1}).lean();if(!b)throw new d.hD("User not found",404);return{id:b._id.toString(),name:b.name,email:b.email,role:b.role,rewardPoints:b.rewardPoints??0}}async function k(a,b){await (0,e.$)();let c={};if(void 0!==b.name&&(c.name=b.name),void 0!==b.email&&(c.email=b.email.toLowerCase()),c.email&&await i.A.findOne({email:c.email,_id:{$ne:a}}).lean())throw new d.hD("Email already in use",409);let f=await i.A.findByIdAndUpdate(a,c,{new:!0,projection:{name:1,email:1,role:1,rewardPoints:1}}).lean();if(!f)throw new d.hD("User not found",404);return{id:f._id.toString(),name:f.name,email:f.email,role:f.role,rewardPoints:f.rewardPoints??0}}async function l(a){return await (0,e.$)(),(await h.A.find({user:a}).sort({_id:-1}).populate({path:"items.book",select:"title slug coverImage"}).lean()).map(a=>({id:a._id.toString(),total:a.total,status:a.status,saleType:a.saleType,paymentMethod:a.paymentMethod,invoiceNumber:a.invoiceNumber,createdAt:a.createdAt??null,items:a.items.map(a=>({quantity:a.quantity,unitPrice:a.unitPrice,book:a.book?{id:a.book._id.toString(),title:a.book.title,slug:a.book.slug,coverImage:a.book.coverImage}:null}))}))}async function m(a){return await (0,e.$)(),(await g.A.find({user:a}).sort({_id:-1}).populate({path:"book",select:"title slug coverImage"}).lean()).map(a=>({id:a._id.toString(),amount:a.amount,reward:a.reward,status:a.status,book:a.book?{id:a.book._id.toString(),title:a.book.title,slug:a.book.slug,coverImage:a.book.coverImage}:null}))}async function n(a){await (0,e.$)();let b=await i.A.findById(a,{wishlist:1}).populate({path:"wishlist",select:"title slug coverImage price saleType authorName"}).lean();if(!b)throw new d.hD("User not found",404);return(Array.isArray(b.wishlist)?b.wishlist:[]).map(a=>({id:a._id.toString(),title:a.title,slug:a.slug,coverImage:a.coverImage,price:a.price,saleType:a.saleType,authorName:a.authorName}))}async function o(a,b){if(await (0,e.$)(),!await f.A.findById(b).lean())throw new d.hD("Book not found",404);return await i.A.findByIdAndUpdate(a,{$addToSet:{wishlist:b}}),n(a)}async function p(a,b){return await (0,e.$)(),await i.A.findByIdAndUpdate(a,{$pull:{wishlist:b}}),n(a)}},53386:(a,b,c)=>{"use strict";c.d(b,{A:()=>g});var d=c(56037),e=c.n(d);let f=new d.Schema({title:{type:String,required:!0,trim:!0},subtitle:{type:String,trim:!0},slug:{type:String,required:!0,unique:!0,lowercase:!0},description:{type:String,required:!0},price:{type:Number,required:!0,min:0},saleType:{type:String,enum:["direct","preorder","crowdfunding"],required:!0},releaseDate:{type:Date},coverImage:{type:String,required:!0},galleryImages:{type:[String],default:[]},isbn:{type:String},pages:{type:Number,min:1},stock:{type:Number,min:0},fundingGoal:{type:Number,min:0},fundingRaised:{type:Number,min:0,default:0},excerptUrl:{type:String},authorName:{type:String},tags:{type:[String],default:[]},preorderNotifiedAt:{type:Date},campaignEndNotifiedAt:{type:Date}},{timestamps:!0}),g=e().models.Book||e().model("Book",f)},63267:(a,b,c)=>{"use strict";c.d(b,{cl:()=>j,hR:()=>i,oC:()=>h});var d=c(82468),e=c(77310),f=c(7634);function g(a){return(0,f.Rb)(a)??(0,f.Qq)(a,e.aq)}function h(a){let b=g(a);if(!b)throw new d.hD("Missing authentication token",401);let c=(0,f.zP)(b);if(!c)throw new d.hD("Invalid or expired token",401);return c}function i(a){let b=g(a);return b?(0,f.zP)(b):null}function j(a,b){if(!b.includes(a.role))throw new d.hD("Forbidden",403)}},77310:(a,b,c)=>{"use strict";c.d(b,{aq:()=>d,lt:()=>e,n_:()=>f});let d="livreo_session",e="livreo_affiliate_ref";function f(){return Number.parseInt(process.env.AUTH_TOKEN_TTL_SECONDS??"604800",10)}},77812:(a,b,c)=>{"use strict";c.d(b,{A:()=>g});var d=c(56037),e=c.n(d);let f=new d.Schema({name:{type:String,required:!0,trim:!0},email:{type:String,required:!0,unique:!0,lowercase:!0},passwordHash:{type:String,required:!0},role:{type:String,enum:["client","admin"],default:"client"},wishlist:[{type:d.Schema.Types.ObjectId,ref:"Book"}],rewardPoints:{type:Number,min:0,default:0},referredBy:{type:String,trim:!0}},{timestamps:!0}),g=e().models.User||e().model("User",f)},78335:()=>{},81799:(a,b,c)=>{"use strict";c.d(b,{bR:()=>n,Si:()=>o,Xl:()=>m});var d=c(82468),e=c(11790),f=c(53386),g=c(56037),h=c.n(g);let i=new g.Schema({book:{type:g.Schema.Types.ObjectId,ref:"Book",required:!0},quantity:{type:Number,required:!0,min:1},unitPrice:{type:Number,required:!0,min:0},title:{type:String,required:!0},slug:{type:String,required:!0},coverImage:{type:String,required:!0},saleType:{type:String,enum:["direct","preorder","crowdfunding"],required:!0}},{_id:!1}),j=new g.Schema({user:{type:g.Schema.Types.ObjectId,ref:"User",required:!0,unique:!0},items:{type:[i],default:[]}},{timestamps:!0}),k=h().models.Cart||h().model("Cart",j);var l=c(35576);async function m(a){await (0,e.$)();let b=await k.findOne({user:a}).lean();return b?{items:b.items}:{items:[]}}async function n(a){await (0,e.$)();let b=await f.A.findById(a.bookId).lean();if(!b)throw new d.hD("Book not found",404);let c=Math.max(1,a.quantity??1),g=await k.findOne({user:a.userId}),h={book:b._id,quantity:c,unitPrice:b.price??0,title:b.title,slug:b.slug,coverImage:b.coverImage,saleType:b.saleType};if(!g)return{items:(await k.create({user:a.userId,items:[h]})).items};let i=g.items.find(b=>b.book.toString()===a.bookId);return i?i.quantity=Math.max(1,i.quantity+c):g.items.push(h),await g.save(),{items:g.items}}async function o(a){await (0,e.$)();let b=await (0,l.Cz)(a);if(!b.length)return{items:[]};let c=await k.findOne({user:a}),d=b.map(a=>({book:a.id,quantity:1,unitPrice:a.price??0,title:a.title??"Ouvrage",slug:a.slug??"",coverImage:a.coverImage??"",saleType:a.saleType??"direct"}));if(!c)return{items:(await k.create({user:a,items:d})).items};for(let a of d){let b=c.items.find(b=>b.book.toString()===String(a.book));b?b.quantity=Math.max(1,b.quantity+a.quantity):c.items.push(a)}return await c.save(),{items:c.items}}},82468:(a,b,c)=>{"use strict";c.d(b,{Cv:()=>f,Vh:()=>h,hD:()=>e,hS:()=>i});var d=c(10641);class e extends Error{constructor(a,b=400){super(a),this.status=b}}function f(a,b=200){return d.NextResponse.json({data:a},{status:b})}function g(a,b=400){return d.NextResponse.json({error:a},{status:b})}async function h(a){try{return await a.json()}catch{throw new e("Invalid JSON body",400)}}function i(a){return a instanceof e?g(a.message,a.status):(a instanceof Error&&console.error("[API_ERROR]",a),g("Internal server error",500))}},96487:()=>{}};